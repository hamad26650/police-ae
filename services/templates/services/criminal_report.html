{% extends 'services/base.html' %}
{% load static %}

{% block title %}فتح بلاغ جنائي - خدمات حكومية{% endblock %}

{% block extra_css %}
    <style>
        :root {
            --primary-blue: #4a90e2;
            --primary-blue-dark: #357abd;
            --accent-blue: #5ca3f5;
            --success-green: #2ecc71;
            --danger-red: #e74c3c;
            --warning-yellow: #f39c12;
        }

        body {
            background: #f5f7fa;
        }

        .report-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            padding: 50px;
            border-radius: 20px;
            color: white;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(74, 144, 226, 0.3);
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 15px;
        }

        .page-header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .form-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-number {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.3rem;
        }

        .section-description {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.05rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--danger-red);
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 14px 18px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .radio-option,
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .radio-option input,
        .checkbox-option input {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .note-box {
            background: #fff9e6;
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 18px;
            margin: 25px 0;
            color: #856404;
        }

        .note-box strong {
            color: #f39c12;
        }

        .add-button {
            background: linear-gradient(135deg, var(--success-green), #27ae60);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
        }

        .file-upload-area {
            border: 3px dashed #e1e8ed;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .file-upload-area:hover {
            border-color: var(--primary-blue);
            background: #f0f7ff;
        }

        .file-upload-area i {
            font-size: 3rem;
            color: var(--primary-blue);
            margin-bottom: 15px;
        }

        .submit-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .declaration-box {
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .declaration-box p {
            color: #2c3e50;
            line-height: 1.8;
            font-size: 1.05rem;
        }

        .agreement-checkbox {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #fff9e6;
            border-radius: 12px;
            border: 2px solid #f39c12;
        }

        .agreement-checkbox input {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .agreement-checkbox label {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            flex: 1;
        }

        .submit-button {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.3);
            width: 100%;
            justify-content: center;
        }

        .submit-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(74, 144, 226, 0.4);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }

        .complaint-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .complaint-type-option {
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .complaint-type-option:hover {
            border-color: var(--primary-blue);
            background: #f0f7ff;
        }

        .complaint-type-option.selected {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
        }

        .party-card {
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .party-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .party-card-title {
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 1.2rem;
        }

        .remove-button {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .remove-button:hover {
            background: #c0392b;
        }

        /* Map Modal Styles */
        .map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .map-modal.active {
            display: flex;
        }

        .map-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .map-modal-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .map-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .map-modal-body {
            flex: 1;
            padding: 20px;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .map-modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .map-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.3);
        }

        .map-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4);
        }

        .map-btn-secondary {
            background: #e1e8ed;
            color: #2c3e50;
        }

        .map-btn-secondary:hover {
            background: #d1d8dd;
        }

        .map-search-box {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 300px;
        }

        .map-search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .current-location-btn {
            position: absolute;
            bottom: 120px;
            left: 20px;
            z-index: 1000;
            background: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 1.2rem;
            color: var(--primary-blue);
            transition: all 0.3s ease;
        }

        .current-location-btn:hover {
            background: var(--primary-blue);
            color: white;
            transform: scale(1.1);
        }

        /* Step Progress Bar */
        .steps-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .steps-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 20px;
        }

        .steps-progress::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e1e8ed;
            z-index: 0;
        }

        .progress-line {
            position: absolute;
            top: 25px;
            left: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            transition: width 0.4s ease;
            z-index: 1;
        }

        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e1e8ed;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 4px solid white;
            box-shadow: 0 0 0 2px #e1e8ed;
        }

        .step-item.active .step-circle {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            box-shadow: 0 0 0 2px var(--primary-blue), 0 5px 15px rgba(74, 144, 226, 0.3);
        }

        .step-item.completed .step-circle {
            background: var(--success-green);
            color: white;
            box-shadow: 0 0 0 2px var(--success-green);
        }

        .step-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.95rem;
            text-align: center;
        }

        .step-item.active .step-label {
            color: var(--primary-blue);
        }

        .step-item.completed .step-label {
            color: var(--success-green);
        }

        /* Form Steps */
        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Navigation Buttons */
        .form-navigation {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e1e8ed;
        }

        .nav-button {
            padding: 16px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .nav-button-prev {
            background: #e1e8ed;
            color: #2c3e50;
        }

        .nav-button-prev:hover {
            background: #d1d8dd;
            transform: translateX(-3px);
        }

        .nav-button-next {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.3);
            margin-left: auto;
        }

        .nav-button-next:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(74, 144, 226, 0.4);
        }

        /* Review Section */
        .review-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e1e8ed;
            position: relative;
        }

        .review-section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-item {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #e1e8ed;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .review-value {
            color: #2c3e50;
            font-weight: 500;
        }

        .edit-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-button:hover {
            background: var(--primary-blue-dark);
            transform: translateY(-2px);
        }

        /* Success Page */
        .success-container {
            text-align: center;
            padding: 60px 20px;
        }

        .success-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--success-green), #27ae60);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-icon i {
            font-size: 4rem;
            color: white;
        }

        .success-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--success-green);
            margin-bottom: 20px;
        }

        .success-message {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .reference-box {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.3);
        }

        .reference-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .reference-number {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 3px;
        }

        .success-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 40px;
        }

        .success-btn {
            padding: 16px 35px;
            border: none;
            border-radius: 50px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .success-btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
            color: white;
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        }

        .success-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(74, 144, 226, 0.4);
        }

        .success-btn-secondary {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .success-btn-secondary:hover {
            background: var(--primary-blue);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .complaint-type-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                padding: 30px 20px;
            }

            .page-header h1 {
                font-size: 1.8rem;
            }

            .form-section {
                padding: 25px 20px;
            }

            .section-title {
                font-size: 1.4rem;
            }

            .steps-container {
                padding: 20px 15px;
            }

            .step-circle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .step-label {
                font-size: 0.75rem;
            }

            .nav-button {
                padding: 14px 25px;
                font-size: 1rem;
            }

            .form-navigation {
                flex-direction: column;
            }

            .nav-button-next {
                margin-left: 0;
            }

            .review-item {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .edit-button {
                position: static;
                margin-bottom: 15px;
                width: 100%;
            }

            .success-title {
                font-size: 2rem;
            }

            .reference-number {
                font-size: 1.8rem;
            }

            .success-actions {
                flex-direction: column;
            }

            .success-btn {
                width: 100%;
                justify-content: center;
            }

            .map-modal-content {
                width: 95%;
                height: 90vh;
            }

            .map-search-box {
                width: calc(100% - 40px);
                top: 10px;
                right: 10px;
            }

            .current-location-btn {
                bottom: 80px;
                left: 10px;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="report-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>⚖️ فتح بلاغ جنائي</h1>
            <p>يرجى تعبئة جميع البيانات بدقة ومصداقية</p>
        </div>

        <!-- Steps Progress -->
        <div class="steps-container">
            <div class="steps-progress">
                <div class="progress-line" id="progressLine"></div>
                <div class="step-item active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">تعبئة البيانات</div>
                </div>
                <div class="step-item" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">مراجعة البيانات</div>
                </div>
                <div class="step-item" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">تأكيد البلاغ</div>
                </div>
            </div>
        </div>

        <form id="criminalReportForm" method="POST">
            {% csrf_token %}

            <!-- Step 1: Form Data -->
            <div class="form-step active" id="step1">

            <!-- القسم الأول: بيانات الشاكي -->
            <div class="form-section">
                <div class="section-title">
                    <span class="section-number">1</span>
                    <span>بيانات الشاكي (مقدم البلاغ)</span>
                </div>
                <p class="section-description">يرجى تعبئة جميع البيانات التالية بدقة</p>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">الاسم الكامل</label>
                        <input type="text" name="complainant_name" class="form-input" required placeholder="أدخل الاسم الكامل">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">رقم الهوية الإماراتية</label>
                        <input type="text" name="complainant_id" class="form-input" required placeholder="784-XXXX-XXXXXXX-X">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">رقم الهاتف المتحرك</label>
                        <input type="tel" name="complainant_phone" class="form-input" required placeholder="05XXXXXXXX">
                    </div>
                    <div class="form-group">
                        <label class="form-label required">البريد الإلكتروني</label>
                        <input type="email" name="complainant_email" class="form-input" required placeholder="example@email.com">
                    </div>
                </div>

                <div class="note-box">
                    <strong>ملاحظة:</strong> تعبئة جميع الحقول إلزامية.
                </div>
            </div>

            <!-- القسم الثاني: بيانات المشكو في حقه -->
            <div class="form-section">
                <div class="section-title">
                    <span class="section-number">2</span>
                    <span>بيانات المشكو في حقه</span>
                </div>
                <p class="section-description">اختر نوع الطرف وأدخل بياناته</p>

                <div id="partiesContainer">
                    <!-- سيتم إضافة الأطراف هنا ديناميكياً -->
                </div>

                <button type="button" class="add-button" onclick="addParty()">
                    <i class="fas fa-plus"></i>
                    إضافة مشكو آخر
                </button>

                <div class="note-box">
                    <strong>ملاحظة:</strong> يمكنك إضافة أكثر من طرف مشكو في حقه. بعد تعبئة بيانات الطرف الأول، اضغط على زر (إضافة مشكو آخر) لإضافة طرف جديد.
                </div>
            </div>

            <!-- القسم الثالث: بيانات البلاغ -->
            <div class="form-section">
                <div class="section-title">
                    <span class="section-number">3</span>
                    <span>بيانات البلاغ</span>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">مركز الشرطة المختص</label>
                        <select name="police_center" class="form-select" required>
                            <option value="">-- اختر المركز --</option>
                            <option value="مركز شرطة واسط الشامل">مركز شرطة واسط الشامل</option>
                            <option value="مركز شرطة الغرب الشامل">مركز شرطة الغرب الشامل</option>
                            <option value="مركز شرطة البحيرة الشامل">مركز شرطة البحيرة الشامل</option>
                            <option value="مركز شرطة الصناعية الشامل">مركز شرطة الصناعية الشامل</option>
                            <option value="مركز شرطة الصجعة الشامل">مركز شرطة الصجعة الشامل</option>
                            <option value="مركز شرطة السيوح الشامل">مركز شرطة السيوح الشامل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">نوع البلاغ</label>
                        <select name="complaint_type" id="complaintType" class="form-select" required onchange="showComplaintDetails()">
                            <option value="">-- اختر نوع البلاغ --</option>
                            <option value="احتيال">احتيال</option>
                            <option value="سب">سب</option>
                            <option value="خيانة الأمانة بالاختلاس">خيانة الأمانة بالاختلاس</option>
                            <option value="خيانة الأمانة بالاستعمال">خيانة الأمانة بالاستعمال</option>
                            <option value="اعتداء بالضرب">اعتداء بالضرب</option>
                            <option value="إتلاف">إتلاف</option>
                            <option value="تهديد">تهديد</option>
                            <option value="تزوير">تزوير</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- القسم الرابع: تفاصيل البلاغ - الاحتيال -->
            <div class="form-section hidden" id="fraudDetails">
                <div class="section-title">
                    <span class="section-number">4</span>
                    <span>تفاصيل البلاغ - الاحتيال</span>
                </div>

                <div class="form-group full-width">
                    <label class="form-label required">1. ما هو موضوع بلاغك بالتفصيل؟</label>
                    <textarea name="complaint_subject" class="form-textarea" placeholder="اشرح موضوع البلاغ بالتفصيل..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">2. متى وقع الحادث؟ (التاريخ)</label>
                        <input type="date" name="incident_date" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">الوقت</label>
                        <input type="time" name="incident_time" class="form-input">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label required">3. أين وقع الحادث؟ (مكان الواقعة)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" name="incident_location" id="incidentLocation" class="form-input" placeholder="حدد مكان الواقعة أو اختر من الخريطة" style="flex: 1;" readonly>
                        <button type="button" class="add-button" onclick="openMapModal()" style="margin: 0; white-space: nowrap;">
                            <i class="fas fa-map-marker-alt"></i>
                            اختر من الخريطة
                        </button>
                    </div>
                    <input type="hidden" name="incident_lat" id="incidentLat">
                    <input type="hidden" name="incident_lng" id="incidentLng">
                    <div id="selectedLocationDisplay" class="hidden" style="background: #e8f8f5; padding: 12px; border-radius: 8px; margin-top: 10px;">
                        <strong style="color: var(--success-green);">✓ الموقع المحدد:</strong>
                        <p id="locationText" style="margin: 5px 0 0 0; color: #2c3e50;"></p>
                        <small style="color: #7f8c8d;">الإحداثيات: <span id="coordsText"></span></small>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label required">4. ما هي طبيعة علاقتك بالمشكو ضده؟</label>
                    <input type="text" name="relationship" class="form-input" placeholder="مثال: صديق، زميل عمل، قريب...">
                </div>

                <div class="form-group full-width">
                    <label class="form-label required">5. ما هو نوع الاتفاق الذي تم بينك وبين المشكو ضده؟</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="agreement_type" value="شفهي">
                            <span>شفهي</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="agreement_type" value="مكتوب">
                            <span>مكتوب</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="agreement_type" value="عبر وسائل التواصل">
                            <span>عبر وسائل التواصل</span>
                        </label>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label required">6. هل قام المشكو ضده بالاستيلاء على مبلغ مالي؟</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="money_seized" value="نعم" onchange="toggleMoneyDetails(true)">
                            <span>نعم</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="money_seized" value="لا" onchange="toggleMoneyDetails(false)">
                            <span>لا</span>
                        </label>
                    </div>
                </div>

                <div class="form-group full-width hidden" id="moneyAmountField">
                    <label class="form-label">كم يقدر المبلغ الإجمالي المستولى عليه؟</label>
                    <input type="number" name="seized_amount" class="form-input" placeholder="أدخل المبلغ بالدرهم">
                </div>

                <div class="form-group full-width hidden" id="propertyTypeField">
                    <label class="form-label">ما هو نوع الممتلكات أو الخدمات المستولى عليها؟</label>
                    <textarea name="seized_property" class="form-textarea" placeholder="اشرح نوع الممتلكات أو الخدمات..."></textarea>
                </div>

                <div class="form-group full-width hidden" id="transferMethodField">
                    <label class="form-label">7. كيف تم تسليم المبلغ المالي للمشكو ضده؟</label>
                    <select name="transfer_method" class="form-select" onchange="toggleTransferDetails()">
                        <option value="">-- اختر طريقة التسليم --</option>
                        <option value="تحويل بنكي">تحويل بنكي</option>
                        <option value="حوالة مصرفية">حوالة مصرفية</option>
                        <option value="محفظة إلكترونية">محفظة إلكترونية</option>
                        <option value="سند قبض">سند قبض</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>

                <div id="bankTransferDetails" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">اسم المصرف</label>
                            <input type="text" name="bank_name" class="form-input" placeholder="اسم البنك">
                        </div>
                        <div class="form-group">
                            <label class="form-label">رقم الحساب أو رقم الآيبان</label>
                            <input type="text" name="account_number" class="form-input" placeholder="AE12XXXXXXXXXXXX">
                        </div>
                    </div>
                </div>

                <div class="form-group full-width hidden" id="otherTransferDetails">
                    <label class="form-label">شرح طريقة التسليم الأخرى</label>
                    <textarea name="other_transfer_method" class="form-textarea" placeholder="اشرح كيف تم تسليم المبلغ..."></textarea>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">8. هل يوجد شهود؟</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="has_witnesses" value="نعم" onchange="toggleWitnesses(true)">
                            <span>نعم</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="has_witnesses" value="لا" onchange="toggleWitnesses(false)">
                            <span>لا</span>
                        </label>
                    </div>
                </div>

                <div class="form-group full-width hidden" id="witnessesField">
                    <label class="form-label">ما هي بيانات الشهود وأرقام التواصل الخاصة بهم؟</label>
                    <textarea name="witnesses_info" class="form-textarea" placeholder="أدخل بيانات الشهود وأرقام الهواتف..."></textarea>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">9. هل لديك ما يثبت صحة ادعائك؟</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="has_evidence" value="نعم" onchange="toggleEvidence(true)">
                            <span>نعم</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="has_evidence" value="لا" onchange="toggleEvidence(false)">
                            <span>لا</span>
                        </label>
                    </div>
                </div>

                <div class="form-group full-width hidden" id="evidenceField">
                    <label class="form-label">ما هي الإثباتات التي لديك؟</label>
                    <textarea name="evidence_description" class="form-textarea" placeholder="اذكر الإثباتات التي لديك..."></textarea>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">10. هل لديك أي أقوال إضافية؟</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="has_additional_statements" value="نعم" onchange="toggleAdditionalStatements(true)">
                            <span>نعم</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="has_additional_statements" value="لا" onchange="toggleAdditionalStatements(false)">
                            <span>لا</span>
                        </label>
                    </div>
                </div>

                <div class="form-group full-width hidden" id="additionalStatementsField">
                    <label class="form-label">أقوال إضافية</label>
                    <textarea name="additional_statements" class="form-textarea" placeholder="أضف أي معلومات إضافية..."></textarea>
                </div>
            </div>

            <!-- القسم الخامس: الأدلة والإثباتات -->
            <div class="form-section">
                <div class="section-title">
                    <span class="section-number">5</span>
                    <span>الأدلة والإثباتات</span>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">1. إثبات التحويل</label>
                    <p class="section-description">يرجى إرفاق ما يثبت عملية التحويل (كشف حساب بنكي، إيصال، إلخ)</p>
                    <div class="file-upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>اضغط لاختيار الملف</strong> أو اسحب الملف هنا</p>
                        <input type="file" name="transfer_proof" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
                    </p>
                    <input type="text" name="transfer_proof_name" class="form-input" placeholder="اسم الملف (اختياري)" style="margin-top:15px;">
                </div>
            </div>

                <div class="form-group full-width">
                    <label class="form-label">2. إثبات الاتفاق أو الاحتيال</label>
                    <p class="section-description">يرجى إرفاق ما يثبت الاتفاق أو الاحتيال من المحادثات أو المستندات</p>
                    <div class="file-upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>اضغط لاختيار الملف</strong> أو اسحب الملف هنا</p>
                        <input type="file" name="agreement_proof" accept=".pdf,.jpg,.jpeg,.png" style="display:none;">
                    </div>
                    <input type="text" name="agreement_proof_name" class="form-input" placeholder="اسم الملف (اختياري)" style="margin-top:15px;">
                </div>

                <div class="form-group full-width">
                    <label class="form-label">3. الوكالة القانونية (إن وجدت)</label>
                    <p class="section-description">يرجى إرفاق الوكالة القانونية في حال توفرها</p>
                    <div class="file-upload-area">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p><strong>اضغط لاختيار الملف</strong> أو اسحب الملف هنا</p>
                        <input type="file" name="power_of_attorney" accept=".pdf" style="display:none;">
                    </div>
                    <input type="text" name="power_of_attorney_name" class="form-input" placeholder="اسم الملف (اختياري)" style="margin-top:15px;">
                </div>
            </div>

            <!-- القسم السادس: الإقرار والتعهد -->
            <div class="submit-section">
                <div class="section-title">
                    <span class="section-number">6</span>
                    <span>الإقرار والتعهد</span>
                </div>

                <div class="declaration-box">
                    <p>
                        أقر بأن جميع المعلومات والبيانات المذكورة أعلاه صحيحة ودقيقة، وأتحمل كامل المسؤولية القانونية عن أي معلومات خاطئة أو مضللة.
                    </p>
                </div>

                <div class="agreement-checkbox">
                    <input type="checkbox" id="agreeTerms" required>
                    <label for="agreeTerms">
                        أوافق على جميع الشروط والأحكام وأقر بصحة جميع المعلومات المدخلة
                    </label>
                </div>
            </div>

            <!-- Navigation Buttons for Step 1 -->
            <div class="form-navigation">
                <button type="button" class="nav-button nav-button-next" onclick="goToStep(2)">
                    التالي: مراجعة البيانات
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>

            </div><!-- End Step 1 -->

            <!-- Step 2: Review Data -->
            <div class="form-step" id="step2">
                <h2 style="color: var(--primary-blue); margin-bottom: 25px; font-size: 1.8rem;">
                    <i class="fas fa-check-circle"></i>
                    مراجعة البيانات
                </h2>
                <p style="color: #7f8c8d; margin-bottom: 30px; font-size: 1.1rem;">
                    يرجى مراجعة جميع البيانات المدخلة والتأكد من صحتها قبل التقديم
                </p>

                <div id="reviewContent">
                    <!-- Review sections will be populated here by JavaScript -->
                </div>

                <!-- Navigation Buttons for Step 2 -->
                <div class="form-navigation">
                    <button type="button" class="nav-button nav-button-prev" onclick="goToStep(1)">
                        <i class="fas fa-arrow-right"></i>
                        السابق
                    </button>
                    <button type="button" class="nav-button nav-button-next" onclick="submitForm()">
                        تأكيد وإرسال البلاغ
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

            </div><!-- End Step 2 -->

            <!-- Step 3: Success -->
            <div class="form-step" id="step3">
                <div class="success-container">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h1 class="success-title">تم تقديم البلاغ بنجاح!</h1>
                    <p class="success-message">تم استلام بلاغك وسيتم مراجعته من قبل الفريق المختص</p>

                    <div class="reference-box">
                        <div class="reference-label">رقم المرجع الخاص بك</div>
                        <div class="reference-number" id="referenceNumber"></div>
                    </div>

                    <div style="background: #fff3cd; padding: 20px; border-radius: 15px; margin: 20px 0; border-right: 5px solid #ffc107;">
                        <p style="margin: 0; color: #856404; font-weight: 600;">
                            <i class="fas fa-info-circle"></i>
                            يرجى الاحتفاظ برقم المرجع للمتابعة والاستعلام عن حالة البلاغ
                        </p>
                    </div>

                    <div class="success-actions">
                        <a href="{% url 'services:interior_ministry' %}" class="success-btn success-btn-primary">
                            <i class="fas fa-home"></i>
                            العودة للصفحة الرئيسية
                        </a>
                        <button type="button" class="success-btn success-btn-secondary" onclick="printReport()">
                            <i class="fas fa-print"></i>
                            طباعة الإيصال
                        </button>
                    </div>
                </div>
            </div><!-- End Step 3 -->

        </form>
    </div>

    <!-- Map Modal -->
    <div class="map-modal" id="mapModal">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> حدد موقع الواقعة</h3>
                <button class="map-modal-close" onclick="closeMapModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="map-modal-body">
                <div style="position: relative; width: 100%; height: 100%;">
                    <div class="map-search-box">
                        <input type="text" id="mapSearch" placeholder="ابحث عن مكان..." dir="rtl">
                    </div>
                    <button class="current-location-btn" onclick="getCurrentLocation()" title="موقعي الحالي">
                        <i class="fas fa-crosshairs"></i>
                    </button>
                    <div id="map"></div>
                </div>
            </div>
            <div class="map-modal-footer">
                <button type="button" class="map-btn map-btn-secondary" onclick="closeMapModal()">
                    إلغاء
                </button>
                <button type="button" class="map-btn map-btn-primary" onclick="confirmLocation()">
                    <i class="fas fa-check"></i> تأكيد الموقع
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places&language=ar"></script>
    
    <script>
        let partyCount = 0;
        let map;
        let marker;
        let selectedLat;
        let selectedLng;
        let geocoder;

        // Initialize: Add first party
        document.addEventListener('DOMContentLoaded', function() {
            addParty();
            
            // Enable submit button when checkbox is checked
            document.getElementById('agreeTerms').addEventListener('change', function() {
                document.getElementById('submitBtn').disabled = !this.checked;
            });

            // File upload handlers
            document.querySelectorAll('.file-upload-area').forEach(area => {
                area.addEventListener('click', function() {
                    this.querySelector('input[type="file"]').click();
                });
                
                const fileInput = area.querySelector('input[type="file"]');
                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) {
                        area.style.borderColor = 'var(--success-green)';
                        area.style.background = '#e8f8f5';
                        area.querySelector('p').innerHTML = '<strong style="color: var(--success-green);">✓ تم اختيار: ' + this.files[0].name + '</strong>';
                    }
                });
            });
        });

        function addParty() {
            partyCount++;
            const container = document.getElementById('partiesContainer');
            
            const partyHTML = `
                <div class="party-card" id="party${partyCount}">
                    <div class="party-card-header">
                        <span class="party-card-title">الطرف ${partyCount}</span>
                        ${partyCount > 1 ? `<button type="button" class="remove-button" onclick="removeParty(${partyCount})"><i class="fas fa-trash"></i> حذف</button>` : ''}
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label required">نوع الطرف</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="party_type_${partyCount}" value="شخص" onchange="togglePartyFields(${partyCount}, 'شخص')" required>
                                <span>شخص</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="party_type_${partyCount}" value="مؤسسة" onchange="togglePartyFields(${partyCount}, 'مؤسسة')">
                                <span>مؤسسة</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="party_type_${partyCount}" value="مجهول" onchange="togglePartyFields(${partyCount}, 'مجهول')">
                                <span>مجهول</span>
                            </label>
                        </div>
                    </div>

                    <div id="personFields_${partyCount}" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">اسم الطرف</label>
                                <input type="text" name="party_name_${partyCount}" class="form-input" placeholder="الاسم الكامل">
                            </div>
                            <div class="form-group">
                                <label class="form-label required">نوع الوثيقة</label>
                                <select name="doc_type_${partyCount}" class="form-select">
                                    <option value="">-- اختر --</option>
                                    <option value="هوية إماراتية">الهوية الإماراتية</option>
                                    <option value="جواز سفر">جواز السفر</option>
                                    <option value="رقم موحد">الرقم الموحد</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">الجنسية</label>
                                <input type="text" name="nationality_${partyCount}" class="form-input" placeholder="الجنسية">
                            </div>
                            <div class="form-group">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="tel" name="party_phone_${partyCount}" class="form-input" placeholder="05XXXXXXXX">
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">العنوان</label>
                            <input type="text" name="party_address_${partyCount}" class="form-input" placeholder="العنوان الكامل">
                        </div>
                    </div>

                    <div id="unknownFields_${partyCount}" class="hidden">
                        <div class="note-box">
                            <strong>ملاحظة:</strong> يمكنك إدخال أي معلومات متاحة عن المشكو في حقه (غير إلزامي)
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">اسم جزئي أو وصف</label>
                                <input type="text" name="unknown_name_${partyCount}" class="form-input" placeholder="أي معلومات متاحة">
                            </div>
                            <div class="form-group">
                                <label class="form-label">رقم هاتف (إن وجد)</label>
                                <input type="tel" name="unknown_phone_${partyCount}" class="form-input" placeholder="05XXXXXXXX">
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">معلومات إضافية</label>
                            <textarea name="unknown_info_${partyCount}" class="form-textarea" placeholder="أي بيانات تعريفية أخرى..."></textarea>
                        </div>
                    </div>

                    <div id="companyFields_${partyCount}" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">اسم المؤسسة</label>
                                <input type="text" name="company_name_${partyCount}" class="form-input" placeholder="اسم المؤسسة">
                            </div>
                            <div class="form-group">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="tel" name="company_phone_${partyCount}" class="form-input" placeholder="04XXXXXXX">
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">العنوان</label>
                            <input type="text" name="company_address_${partyCount}" class="form-input" placeholder="عنوان المؤسسة">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', partyHTML);
        }

        function removeParty(id) {
            document.getElementById('party' + id).remove();
        }

        function togglePartyFields(id, type) {
            document.getElementById('personFields_' + id).classList.add('hidden');
            document.getElementById('unknownFields_' + id).classList.add('hidden');
            document.getElementById('companyFields_' + id).classList.add('hidden');
            
            if (type === 'شخص') {
                document.getElementById('personFields_' + id).classList.remove('hidden');
            } else if (type === 'مجهول') {
                document.getElementById('unknownFields_' + id).classList.remove('hidden');
            } else if (type === 'مؤسسة') {
                document.getElementById('companyFields_' + id).classList.remove('hidden');
            }
        }

        function showComplaintDetails() {
            const type = document.getElementById('complaintType').value;
            const fraudDetails = document.getElementById('fraudDetails');
            
            if (type === 'احتيال') {
                fraudDetails.classList.remove('hidden');
            } else {
                fraudDetails.classList.add('hidden');
            }
        }

        function toggleMoneyDetails(hasMoney) {
            document.getElementById('moneyAmountField').classList.toggle('hidden', !hasMoney);
            document.getElementById('propertyTypeField').classList.toggle('hidden', hasMoney);
            document.getElementById('transferMethodField').classList.toggle('hidden', !hasMoney);
            
            if (!hasMoney) {
                document.getElementById('bankTransferDetails').classList.add('hidden');
                document.getElementById('otherTransferDetails').classList.add('hidden');
            }
        }

        function toggleTransferDetails() {
            const method = document.querySelector('[name="transfer_method"]').value;
            document.getElementById('bankTransferDetails').classList.toggle('hidden', method !== 'تحويل بنكي');
            document.getElementById('otherTransferDetails').classList.toggle('hidden', method !== 'أخرى');
        }

        function toggleWitnesses(has) {
            document.getElementById('witnessesField').classList.toggle('hidden', !has);
        }

        function toggleEvidence(has) {
            document.getElementById('evidenceField').classList.toggle('hidden', !has);
        }

        function toggleAdditionalStatements(has) {
            document.getElementById('additionalStatementsField').classList.toggle('hidden', !has);
        }

        // Google Maps Functions
        function openMapModal() {
            document.getElementById('mapModal').classList.add('active');
            
            // Initialize map if not already initialized
            if (!map) {
                initMap();
            }
        }

        function closeMapModal() {
            document.getElementById('mapModal').classList.remove('active');
        }

        function initMap() {
            // Default location: Sharjah, UAE
            const defaultLocation = { lat: 25.3463, lng: 55.4209 };
            
            geocoder = new google.maps.Geocoder();
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 13,
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: false,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'on' }]
                    }
                ]
            });

            // Add marker
            marker = new google.maps.Marker({
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
                position: defaultLocation
            });

            // Update coordinates on marker drag
            marker.addListener('dragend', function() {
                const position = marker.getPosition();
                selectedLat = position.lat();
                selectedLng = position.lng();
                getAddressFromCoords(selectedLat, selectedLng);
            });

            // Add click listener to map
            map.addListener('click', function(event) {
                marker.setPosition(event.latLng);
                selectedLat = event.latLng.lat();
                selectedLng = event.latLng.lng();
                getAddressFromCoords(selectedLat, selectedLng);
            });

            // Set initial selection
            selectedLat = defaultLocation.lat;
            selectedLng = defaultLocation.lng;

            // Setup search box
            setupSearchBox();
        }

        function setupSearchBox() {
            const searchBox = new google.maps.places.SearchBox(document.getElementById('mapSearch'));
            
            map.addListener('bounds_changed', function() {
                searchBox.setBounds(map.getBounds());
            });

            searchBox.addListener('places_changed', function() {
                const places = searchBox.getPlaces();
                
                if (places.length === 0) return;
                
                const place = places[0];
                
                if (!place.geometry || !place.geometry.location) return;
                
                map.setCenter(place.geometry.location);
                map.setZoom(15);
                marker.setPosition(place.geometry.location);
                
                selectedLat = place.geometry.location.lat();
                selectedLng = place.geometry.location.lng();
            });
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(pos);
                        map.setZoom(15);
                        marker.setPosition(pos);
                        
                        selectedLat = pos.lat;
                        selectedLng = pos.lng;
                        
                        getAddressFromCoords(selectedLat, selectedLng);
                    },
                    function() {
                        alert('لم نتمكن من الوصول إلى موقعك الحالي');
                    }
                );
            } else {
                alert('المتصفح لا يدعم تحديد الموقع');
            }
        }

        function getAddressFromCoords(lat, lng) {
            const latlng = { lat: lat, lng: lng };
            
            geocoder.geocode({ location: latlng }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    document.getElementById('mapSearch').value = results[0].formatted_address;
                }
            });
        }

        function confirmLocation() {
            if (!selectedLat || !selectedLng) {
                alert('يرجى تحديد موقع على الخريطة');
                return;
            }
            
            const latlng = { lat: selectedLat, lng: selectedLng };
            
            geocoder.geocode({ location: latlng }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const address = results[0].formatted_address;
                    
                    // Update form fields
                    document.getElementById('incidentLocation').value = address;
                    document.getElementById('incidentLat').value = selectedLat;
                    document.getElementById('incidentLng').value = selectedLng;
                    
                    // Show selected location
                    document.getElementById('selectedLocationDisplay').classList.remove('hidden');
                    document.getElementById('locationText').textContent = address;
                    document.getElementById('coordsText').textContent = selectedLat.toFixed(6) + ', ' + selectedLng.toFixed(6);
                    
                    closeMapModal();
                } else {
                    alert('لم نتمكن من تحديد العنوان، يرجى المحاولة مرة أخرى');
                }
            });
        }

        // Step Navigation
        let currentStep = 1;

        function goToStep(stepNumber) {
            // Validate current step before moving
            if (stepNumber > currentStep) {
                if (!validateStep(currentStep)) {
                    return;
                }
            }

            // Hide all steps
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });

            // Show target step
            document.getElementById('step' + stepNumber).classList.add('active');

            // Update progress bar
            updateProgressBar(stepNumber);

            // If going to step 2, populate review data
            if (stepNumber === 2) {
                populateReview();
            }

            currentStep = stepNumber;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateStep(stepNumber) {
            if (stepNumber === 1) {
                const agreeTerms = document.getElementById('agreeTerms');
                if (!agreeTerms.checked) {
                    alert('يرجى الموافقة على الشروط والأحكام للمتابعة');
                    agreeTerms.focus();
                    return false;
                }

                // Check required fields
                const requiredFields = document.querySelectorAll('#step1 [required]');
                for (let field of requiredFields) {
                    if (!field.value.trim() && field.type !== 'checkbox' && field.type !== 'radio') {
                        alert('يرجى تعبئة جميع الحقول المطلوبة');
                        field.focus();
                        return false;
                    }
                }

                // Check if at least one party type is selected
                const partyCards = document.querySelectorAll('.party-card');
                for (let card of partyCards) {
                    const partyTypeRadios = card.querySelectorAll('input[type="radio"][name^="party_type_"]');
                    let isChecked = false;
                    partyTypeRadios.forEach(radio => {
                        if (radio.checked) isChecked = true;
                    });
                    if (!isChecked) {
                        alert('يرجى اختيار نوع الطرف للمشكو في حقه');
                        return false;
                    }
                }
            }
            return true;
        }

        function updateProgressBar(stepNumber) {
            // Update step items
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const step = index + 1;
                item.classList.remove('active', 'completed');

                if (step < stepNumber) {
                    item.classList.add('completed');
                } else if (step === stepNumber) {
                    item.classList.add('active');
                }
            });

            // Update progress line width
            const progressLine = document.getElementById('progressLine');
            const progressPercent = ((stepNumber - 1) / 2) * 100;
            progressLine.style.width = progressPercent + '%';
        }

        function populateReview() {
            const reviewContent = document.getElementById('reviewContent');
            let html = '';

            // Section 1: Complainant Data
            html += '<div class="review-section">';
            html += '<button type="button" class="edit-button" onclick="goToStep(1)"><i class="fas fa-edit"></i> تعديل</button>';
            html += '<div class="review-section-title"><i class="fas fa-user"></i> بيانات الشاكي</div>';
            html += createReviewItem('الاسم الكامل', 'complainant_name');
            html += createReviewItem('رقم الهوية', 'complainant_id');
            html += createReviewItem('رقم الهاتف', 'complainant_phone');
            html += createReviewItem('البريد الإلكتروني', 'complainant_email');
            html += '</div>';

            // Section 2: Reported Parties
            html += '<div class="review-section">';
            html += '<button type="button" class="edit-button" onclick="goToStep(1)"><i class="fas fa-edit"></i> تعديل</button>';
            html += '<div class="review-section-title"><i class="fas fa-users"></i> بيانات المشكو في حقه</div>';
            const parties = document.querySelectorAll('.party-card');
            
            if (parties.length > 0) {
                parties.forEach((party, index) => {
                    html += `<div style="background: #f0f7ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid var(--primary-blue);">`;
                    html += `<p style="font-weight: 700; color: var(--primary-blue); margin: 0 0 15px 0; font-size: 1.1rem;">الطرف ${index + 1}</p>`;
                    
                    const partyTypeInput = party.querySelector('input[name^="party_type_"]:checked');
                    const partyType = partyTypeInput ? partyTypeInput.value : '';
                    
                    if (partyType) {
                        html += '<div class="review-item"><span class="review-label">نوع الطرف:</span><span class="review-value">' + partyType + '</span></div>';
                    }

                    if (partyType === 'شخص') {
                        const partyId = index + 1;
                        const nameInput = party.querySelector(`input[name="party_name_${partyId}"]`);
                        const docTypeSelect = party.querySelector(`select[name="doc_type_${partyId}"]`);
                        const nationalityInput = party.querySelector(`input[name="nationality_${partyId}"]`);
                        const phoneInput = party.querySelector(`input[name="party_phone_${partyId}"]`);
                        const addressInput = party.querySelector(`input[name="party_address_${partyId}"]`);

                        if (nameInput && nameInput.value) html += '<div class="review-item"><span class="review-label">الاسم:</span><span class="review-value">' + nameInput.value + '</span></div>';
                        if (docTypeSelect && docTypeSelect.value) html += '<div class="review-item"><span class="review-label">نوع الوثيقة:</span><span class="review-value">' + docTypeSelect.value + '</span></div>';
                        if (nationalityInput && nationalityInput.value) html += '<div class="review-item"><span class="review-label">الجنسية:</span><span class="review-value">' + nationalityInput.value + '</span></div>';
                        if (phoneInput && phoneInput.value) html += '<div class="review-item"><span class="review-label">رقم الهاتف:</span><span class="review-value">' + phoneInput.value + '</span></div>';
                        if (addressInput && addressInput.value) html += '<div class="review-item"><span class="review-label">العنوان:</span><span class="review-value">' + addressInput.value + '</span></div>';
                    } else if (partyType === 'مؤسسة') {
                        const partyId = index + 1;
                        const companyNameInput = party.querySelector(`input[name="company_name_${partyId}"]`);
                        const companyPhoneInput = party.querySelector(`input[name="company_phone_${partyId}"]`);
                        const companyAddressInput = party.querySelector(`input[name="company_address_${partyId}"]`);

                        if (companyNameInput && companyNameInput.value) html += '<div class="review-item"><span class="review-label">اسم المؤسسة:</span><span class="review-value">' + companyNameInput.value + '</span></div>';
                        if (companyPhoneInput && companyPhoneInput.value) html += '<div class="review-item"><span class="review-label">رقم الهاتف:</span><span class="review-value">' + companyPhoneInput.value + '</span></div>';
                        if (companyAddressInput && companyAddressInput.value) html += '<div class="review-item"><span class="review-label">العنوان:</span><span class="review-value">' + companyAddressInput.value + '</span></div>';
                    } else if (partyType === 'مجهول') {
                        const partyId = index + 1;
                        const unknownNameInput = party.querySelector(`input[name="unknown_name_${partyId}"]`);
                        const unknownPhoneInput = party.querySelector(`input[name="unknown_phone_${partyId}"]`);
                        const unknownInfoInput = party.querySelector(`textarea[name="unknown_info_${partyId}"]`);

                        if (unknownNameInput && unknownNameInput.value) html += '<div class="review-item"><span class="review-label">الوصف:</span><span class="review-value">' + unknownNameInput.value + '</span></div>';
                        if (unknownPhoneInput && unknownPhoneInput.value) html += '<div class="review-item"><span class="review-label">رقم الهاتف:</span><span class="review-value">' + unknownPhoneInput.value + '</span></div>';
                        if (unknownInfoInput && unknownInfoInput.value) html += '<div class="review-item"><span class="review-label">معلومات إضافية:</span><span class="review-value">' + unknownInfoInput.value + '</span></div>';
                    }
                    
                    html += '</div>';
                });
            } else {
                html += '<p style="color: #7f8c8d; font-style: italic;">لا توجد بيانات</p>';
            }
            
            html += '</div>';

            // Section 3: Report Data
            html += '<div class="review-section">';
            html += '<button type="button" class="edit-button" onclick="goToStep(1)"><i class="fas fa-edit"></i> تعديل</button>';
            html += '<div class="review-section-title"><i class="fas fa-file-alt"></i> بيانات البلاغ</div>';
            html += createReviewItem('مركز الشرطة المختص', 'police_center');
            html += createReviewItem('نوع البلاغ', 'complaint_type');
            html += '</div>';

            // Section 4: Report Details
            const complaintType = document.getElementById('complaintType').value;
            if (complaintType === 'احتيال') {
                html += '<div class="review-section" style="border: 2px solid var(--primary-blue); background: #f8fbff;">';
                html += '<button type="button" class="edit-button" onclick="goToStep(1)"><i class="fas fa-edit"></i> تعديل</button>';
                html += '<div class="review-section-title" style="font-size: 1.5rem;"><i class="fas fa-clipboard-list"></i> تفاصيل البلاغ</div>';
                
                html += createReviewTextarea('موضوع البلاغ', 'complaint_subject');
                html += createReviewItem('تاريخ الواقعة', 'incident_date');
                html += createReviewItem('وقت الواقعة', 'incident_time');
                
                const incidentLocation = document.getElementById('incidentLocation');
                const incidentLat = document.getElementById('incidentLat');
                const incidentLng = document.getElementById('incidentLng');
                if (incidentLocation && incidentLocation.value) {
                    html += '<div class="review-item"><span class="review-label">مكان الواقعة:</span><span class="review-value">' + incidentLocation.value;
                    if (incidentLat && incidentLat.value && incidentLng && incidentLng.value) {
                        html += '<br><small style="color: #7f8c8d;"><i class="fas fa-map-marker-alt"></i> الإحداثيات: ' + parseFloat(incidentLat.value).toFixed(6) + ', ' + parseFloat(incidentLng.value).toFixed(6) + '</small>';
                    }
                    html += '</span></div>';
                }

                html += createReviewItem('طبيعة العلاقة', 'relationship');
                html += createReviewRadio('نوع الاتفاق', 'agreement_type');
                html += createReviewRadio('الاستيلاء على مبلغ مالي', 'money_seized');
                html += createReviewItem('المبلغ المستولى عليه', 'seized_amount');
                html += createReviewItem('طريقة التسليم', 'transfer_method');
                html += createReviewItem('اسم المصرف', 'bank_name');
                html += createReviewItem('رقم الحساب', 'account_number');
                html += createReviewRadio('وجود شهود', 'has_witnesses');
                html += createReviewTextarea('بيانات الشهود', 'witnesses_info');
                html += createReviewRadio('وجود إثباتات', 'has_evidence');
                html += createReviewTextarea('الإثباتات', 'evidence_description');
                html += createReviewTextarea('أقوال إضافية', 'additional_statements');
                
                html += '</div>';
            }

            // Section 5: Evidence Files
            html += '<div class="review-section">';
            html += '<button type="button" class="edit-button" onclick="goToStep(1)"><i class="fas fa-edit"></i> تعديل</button>';
            html += '<div class="review-section-title"><i class="fas fa-paperclip"></i> الأدلة والإثباتات المرفقة</div>';
            
            const transferProof = document.querySelector('input[name="transfer_proof"]');
            const agreementProof = document.querySelector('input[name="agreement_proof"]');
            const powerOfAttorney = document.querySelector('input[name="power_of_attorney"]');
            
            if (transferProof && transferProof.files.length > 0) {
                html += '<div class="review-item"><span class="review-label">إثبات التحويل:</span><span class="review-value"><i class="fas fa-file"></i> ' + transferProof.files[0].name + '</span></div>';
            }
            if (agreementProof && agreementProof.files.length > 0) {
                html += '<div class="review-item"><span class="review-label">إثبات الاتفاق:</span><span class="review-value"><i class="fas fa-file"></i> ' + agreementProof.files[0].name + '</span></div>';
            }
            if (powerOfAttorney && powerOfAttorney.files.length > 0) {
                html += '<div class="review-item"><span class="review-label">الوكالة القانونية:</span><span class="review-value"><i class="fas fa-file"></i> ' + powerOfAttorney.files[0].name + '</span></div>';
            }
            
            if (!transferProof?.files.length && !agreementProof?.files.length && !powerOfAttorney?.files.length) {
                html += '<p style="color: #7f8c8d; font-style: italic;">لا توجد ملفات مرفقة</p>';
            }
            
            html += '</div>';

            reviewContent.innerHTML = html;
        }

        function createReviewItem(label, fieldName) {
            const field = document.querySelector('[name="' + fieldName + '"]');
            if (!field || !field.value) return '';

            let value = field.value;

            if (field.tagName === 'SELECT') {
                value = field.options[field.selectedIndex].text;
            }

            return `<div class="review-item">
                        <span class="review-label">${label}:</span>
                        <span class="review-value">${value}</span>
                    </div>`;
        }

        function createReviewTextarea(label, fieldName) {
            const field = document.querySelector('[name="' + fieldName + '"]');
            if (!field || !field.value) return '';

            return `<div class="review-item">
                        <span class="review-label">${label}:</span>
                        <span class="review-value" style="white-space: pre-wrap;">${field.value}</span>
                    </div>`;
        }

        function createReviewRadio(label, fieldName) {
            const field = document.querySelector('input[name="' + fieldName + '"]:checked');
            if (!field || !field.value) return '';

            return `<div class="review-item">
                        <span class="review-label">${label}:</span>
                        <span class="review-value">${field.value}</span>
                    </div>`;
        }

        function submitForm() {
            // Collect form data
            const formData = new FormData(document.getElementById('criminalReportForm'));
            
            // Send via AJAX
            fetch('{% url "services:criminal_report" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Display reference number
                    document.getElementById('referenceNumber').textContent = data.reference_number;
                    
                    // Go to success page
                    goToStep(3);
                } else {
                    alert('حدث خطأ: ' + data.message);
                }
            })
            .catch(error => {
                alert('حدث خطأ في الاتصال: ' + error);
            });
        }

        function printReport() {
            window.print();
        }

        // Initialize
        updateProgressBar(1);
    </script>
{% endblock %}
