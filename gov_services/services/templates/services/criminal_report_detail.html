<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¨Ù„Ø§Øº {{ report.reference_number }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Top Navigation */
        .top-nav {
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .report-ref {
            font-size: 1.5rem;
            font-weight: 800;
            color: #495057;
        }

        .report-ref span {
            color: #0066cc;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .btn-back {
            background: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background: #5a6268;
        }

        .btn-print {
            background: #28a745;
            color: white;
        }

        .btn-print:hover {
            background: #218838;
        }

        /* Main Content */
        .content-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* Status Bar */
        .status-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-info h2 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .status-badge {
            background: rgba(255,255,255,0.25);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .status-dates {
            text-align: left;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #0066cc;
            background: white;
            border-bottom-color: #0066cc;
        }

        .tab i {
            margin-left: 8px;
            font-size: 1.1rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid Layout */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-right: 4px solid #0066cc;
        }

        .info-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 1rem;
            color: #212529;
            font-weight: 600;
        }

        /* Full Width Card */
        .full-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .full-card-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 700;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .full-card-value {
            font-size: 1rem;
            color: #212529;
            line-height: 1.8;
        }

        /* Accused List */
        .accused-list {
            display: grid;
            gap: 15px;
        }

        .accused-item {
            background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
        }

        .accused-number {
            background: #ffc107;
            color: #212529;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        /* Actions Panel */
        .actions-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 30px;
            border-radius: 10px;
        }

        .actions-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-reserve { background: #0066cc; color: white; }
        .btn-release { background: #ff9800; color: white; }
        .btn-approve { background: #28a745; color: white; }
        .btn-reject { background: #dc3545; color: white; }
        .btn-archive { background: #6c757d; color: white; }
        .btn-questions { background: #6f42c1; color: white; }

        /* Reserved Box */
        .reserved-box {
            background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .reserved-box i {
            font-size: 3rem;
            color: #ff9800;
            margin-bottom: 10px;
        }

        .reserved-box h3 {
            color: #856404;
            margin-bottom: 5px;
        }

        .reserved-box p {
            color: #856404;
            font-size: 0.9rem;
        }

        /* Notes Section */
        .notes-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .notes-title {
            font-weight: 700;
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.95rem;
            resize: vertical;
            margin-bottom: 15px;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: #0066cc;
        }

        .btn-save-notes {
            background: #0066cc;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .btn-save-notes:hover {
            background: #0052a3;
        }

        /* Note Items */
        .note-item {
            transition: all 0.3s ease;
        }

        .note-item:hover {
            box-shadow: 0 2px 8px rgba(0,102,204,0.2);
            transform: translateX(-2px);
        }

        #notesList::-webkit-scrollbar {
            width: 8px;
        }

        #notesList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        #notesList::-webkit-scrollbar-thumb {
            background: #0066cc;
            border-radius: 10px;
        }

        #notesList::-webkit-scrollbar-thumb:hover {
            background: #0052a3;
        }

        /* Questions Section */
        .questions-section {
            display: none;
            margin-top: 20px;
        }

        .questions-section.show {
            display: block;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #adb5bd;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .tab {
                flex: none;
                min-width: 150px;
            }

            .status-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .status-dates {
                text-align: center;
            }
        }

        @media print {
            body {
                background: white;
            }

            .top-nav,
            .tabs,
            .actions-panel,
            .notes-box {
                display: none !important;
            }

            .tab-content {
                display: block !important;
            }

            .content-wrapper {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="report-ref">
                Ø§Ù„Ø¨Ù„Ø§Øº Ø±Ù‚Ù… <span>{{ report.reference_number }}</span>
            </div>
            <div class="nav-buttons">
                <a href="{% url 'services:staff_criminal_reports' %}" class="nav-btn btn-back">
                    <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                </a>
                <button class="nav-btn btn-print" onclick="window.print()">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-info">
                    <h2>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº</h2>
                    <div class="status-badge">{{ report.get_status_display }}</div>
                </div>
                <div class="status-dates">
                    <div>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…: {{ report.created_at|date:"d/m/Y" }}</div>
                    <div>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {{ report.updated_at|date:"d/m/Y H:i" }}</div>
                    {% if report.reserved_by %}
                    <div style="margin-top: 5px; font-weight: 600;">
                        Ù…Ø­Ø¬ÙˆØ²: {{ report.reserved_by.get_full_name|default:report.reserved_by.username }}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('complainant')">
                    <i class="fas fa-user"></i> Ø§Ù„Ø´Ø§ÙƒÙŠ
                </div>
                <div class="tab" onclick="showTab('accused')">
                    <i class="fas fa-users"></i> Ø§Ù„Ù…Ø´ÙƒÙˆ ÙÙŠ Ø­Ù‚Ù‡
                </div>
                <div class="tab" onclick="showTab('details')">
                    <i class="fas fa-info-circle"></i> Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </div>
                <div class="tab" onclick="showTab('actions')">
                    <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                </div>
            </div>

            <!-- Tab 1: Complainant -->
            <div id="tab-complainant" class="tab-content active">
                <h3 style="margin-bottom: 25px; color: #495057; font-size: 1.3rem;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§ÙƒÙŠ</h3>
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</div>
                        <div class="info-value">{{ report.complainant_name }}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</div>
                        <div class="info-value">{{ report.complainant_id }}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
                        <div class="info-value">{{ report.complainant_phone }}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
                        <div class="info-value">{{ report.complainant_email|default:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }}</div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Accused -->
            <div id="tab-accused" class="tab-content">
                {% if report.accused_parties %}
                    {% for party in report.accused_parties %}
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: #0066cc; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-user-circle"></i> Ø§Ù„Ù…Ø´ÙƒÙˆ ÙÙŠ Ø­Ù‚Ù‡ {{ forloop.counter }}
                        </h3>
                        
                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-right: 4px solid #0066cc;">
                            <div class="info-grid">
                                <div class="info-card">
                                    <div class="info-label">Ù†ÙˆØ¹ Ø§Ù„Ø·Ø±Ù</div>
                                    <div class="info-value">{{ party.type }}</div>
                                </div>
                                
                                {% if party.name %}
                                <div class="info-card">
                                    <div class="info-label">Ø§Ù„Ø§Ø³Ù…</div>
                                    <div class="info-value">{{ party.name }}</div>
                                </div>
                                {% endif %}
                                
                                {% if party.doc_type %}
                                <div class="info-card">
                                    <div class="info-label">Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</div>
                                    <div class="info-value">{{ party.doc_type }}</div>
                                </div>
                                {% endif %}
                                
                                {% if party.nationality %}
                                <div class="info-card">
                                    <div class="info-label">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</div>
                                    <div class="info-value">{{ party.nationality }}</div>
                                </div>
                                {% endif %}
                                
                                {% if party.phone %}
                                <div class="info-card">
                                    <div class="info-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
                                    <div class="info-value">{{ party.phone }}</div>
                                </div>
                                {% endif %}
                                
                                {% if party.address %}
                                <div class="info-card">
                                    <div class="info-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
                                    <div class="info-value">{{ party.address }}</div>
                                </div>
                                {% endif %}
                                
                                {% if party.info %}
                                <div class="info-card" style="grid-column: 1 / -1;">
                                    <div class="info-label">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>
                                    <div class="info-value">{{ party.info }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-user-slash"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·Ø±Ø§Ù Ù…Ø¶Ø§ÙØ©</p>
                </div>
                {% endif %}
            </div>

            <!-- Tab 3: Details -->
            <div id="tab-details" class="tab-content">
                <!-- Ù…Ø­Ø¶Ø± Ø§Ù„Ø§Ø³ØªØ¯Ù„Ø§Ù„ -->
                <h3 style="margin-bottom: 20px; color: #495057; font-size: 1.2rem; font-weight: 700; padding-bottom: 10px; border-bottom: 2px solid #dee2e6;">
                    Ù…Ø­Ø¶Ø± Ø§Ù„Ø§Ø³ØªØ¯Ù„Ø§Ù„
                </h3>
                <div class="info-grid" style="margin-bottom: 30px;">
                    <div class="info-card">
                        <div class="info-label">Ù…Ø±ÙƒØ² Ø§Ù„Ø´Ø±Ø·Ø© Ø§Ù„Ù…Ø®ØªØµ</div>
                        <div class="info-value">{{ report.police_center }}</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº</div>
                        <div class="info-value" style="color: #dc3545; font-weight: 700;">{{ report.complaint_type }}</div>
                    </div>
                </div>

                <!-- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø© -->
                <div class="full-card">
                    <div class="full-card-title">Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº</div>
                    <div class="full-card-value">{{ report.complaint_subject }}</div>
                </div>

                <div class="full-card">
                    <div class="full-card-title">Ø£ÙŠÙ† ÙˆÙ…ØªÙ‰ Ø­Ø¯Ø« Ø°Ù„ÙƒØŸ</div>
                    <div class="full-card-value">
                        {% if report.incident_date %}
                        <div style="margin-bottom: 10px;">
                            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ report.incident_date }}
                            {% if report.incident_time %}
                            <strong style="margin-right: 20px;">Ø§Ù„ÙˆÙ‚Øª:</strong> {{ report.incident_time }}
                            {% endif %}
                        </div>
                        {% elif report.incident_time %}
                        <div style="margin-bottom: 10px;">
                            <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> {{ report.incident_time }}
                        </div>
                        {% endif %}
                        <div>
                            <strong>Ø§Ù„Ù…ÙƒØ§Ù†:</strong> {{ report.incident_location }}
                        </div>
                    </div>
                </div>

                {% if report.relationship %}
                <div class="full-card">
                    <div class="full-card-title">Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨Ø§Ù„Ù…Ø´ÙƒÙˆ ÙÙŠ Ø­Ù‚Ù‡</div>
                    <div class="full-card-value">{{ report.relationship }}</div>
                </div>
                {% endif %}

                {% if report.agreement_type %}
                <div class="full-card">
                    <div class="full-card-title">Ù†ÙˆØ¹ Ø§Ù„Ø§ØªÙØ§Ù‚</div>
                    <div class="full-card-value">{{ report.agreement_type }}</div>
                </div>
                {% endif %}

                {% if report.money_seized %}
                <div class="full-card">
                    <div class="full-card-title">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙˆÙ„Ù‰ Ø¹Ù„ÙŠÙ‡</div>
                    <div class="full-card-value" style="color: #dc3545; font-weight: 700; font-size: 1.1rem;">{{ report.money_seized }}</div>
                </div>
                {% endif %}

                {% if report.transfer_method %}
                <div class="full-card">
                    <div class="full-card-title">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„/Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
                    <div class="full-card-value">{{ report.transfer_method }}</div>
                </div>
                {% endif %}

                {% if report.witnesses %}
                <div class="full-card">
                    <div class="full-card-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡ÙˆØ¯</div>
                    <div class="full-card-value">{{ report.witnesses }}</div>
                </div>
                {% endif %}

                {% if report.evidence %}
                <div class="full-card">
                    <div class="full-card-title">Ø§Ù„Ø¥Ø«Ø¨Ø§ØªØ§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©</div>
                    <div class="full-card-value">{{ report.evidence }}</div>
                </div>
                {% endif %}

                {% if report.additional_statements %}
                <div class="full-card">
                    <div class="full-card-title">Ø£Ù‚ÙˆØ§Ù„ ÙˆØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©</div>
                    <div class="full-card-value">{{ report.additional_statements }}</div>
                </div>
                {% endif %}

                <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© -->
                {% if report.reserved_by == current_user %}
                <div style="margin-top: 30px; text-align: center;">
                    <button class="action-btn btn-questions" onclick="showQuestionsInDetails()" style="max-width: 400px; margin: 0 auto;">
                        <i class="fas fa-question-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¦Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…ØªØ¹Ø§Ù…Ù„
                    </button>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© -->
                <div class="notes-box questions-section" id="questionsSectionDetails" style="margin-top: 20px;">
                    <div class="notes-title"><i class="fas fa-question-circle"></i> Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ù…ØªØ¹Ø§Ù…Ù„</div>
                    <textarea class="notes-textarea" id="additionalQuestionsDetails" placeholder="Ø§ÙƒØªØ¨ Ø£Ø³Ø¦Ù„ØªÙƒ Ù„Ù„Ù…ØªØ¹Ø§Ù…Ù„ Ù‡Ù†Ø§...">{{ report.additional_questions|default:"" }}</textarea>
                    <button class="btn-save-notes" onclick="saveNotesFromDetails('questions')">
                        <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Tab 4: Actions -->
            <div id="tab-actions" class="tab-content">
                <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² -->
                {% if report.reserved_by and report.reserved_by != current_user %}
                <div style="background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%); border: 2px solid #ffc107; border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 30px;">
                    <i class="fas fa-user-lock" style="font-size: 3rem; color: #ff9800; margin-bottom: 15px;"></i>
                    <h3 style="color: #856404; font-size: 1.3rem; margin-bottom: 10px;">Ø§Ù„Ø¨Ù„Ø§Øº Ù…Ø­Ø¬ÙˆØ²</h3>
                    <p style="color: #856404; font-size: 1.1rem; font-weight: 600;">{{ report.reserved_by.get_full_name|default:report.reserved_by.username }}</p>
                    <p style="color: #856404; font-size: 0.9rem; margin-top: 5px;">{{ report.reserved_at|date:"d/m/Y H:i" }}</p>
                </div>
                {% endif %}

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                {% if not report.reserved_by %}
                    <!-- ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ² -->
                    <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <i class="fas fa-unlock" style="font-size: 3rem; color: #0066cc; margin-bottom: 15px;"></i>
                        <h3 style="color: #495057; font-size: 1.2rem; margin-bottom: 20px;">Ø§Ù„Ø¨Ù„Ø§Øº Ù…ØªØ§Ø­ Ù„Ù„Ø­Ø¬Ø²</h3>
                        <form method="POST" action="{% url 'services:reserve_criminal_report' report.id %}">
                            {% csrf_token %}
                            <button type="submit" style="background: #0066cc; color: white; padding: 15px 40px; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; font-size: 1.1rem; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,102,204,0.3); transition: 0.3s;">
                                <i class="fas fa-lock"></i> Ø­Ø¬Ø² Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ø³Ù…ÙŠ
                            </button>
                        </form>
                    </div>
                
                {% elif report.reserved_by == current_user %}
                    <!-- Ù…Ø­Ø¬ÙˆØ² Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø­Ø§Ù„ÙŠ -->
                    <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #495057; font-size: 1.2rem; margin-bottom: 20px; text-align: center;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¨Ù„Ø§Øº</h3>
                        
                        <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                            <form method="POST" action="{% url 'services:release_criminal_report' report.id %}">
                                {% csrf_token %}
                                <button type="submit" style="width: 100%; background: #ff9800; color: white; padding: 15px; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;">
                                    <i class="fas fa-unlock"></i> ÙÙƒ Ø§Ù„Ø­Ø¬Ø²
                                </button>
                            </form>
                            
                            <a href="{% url 'services:create_official_report' report.id %}" style="width: 100%; background: #28a745; color: white; padding: 15px; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; text-decoration: none;">
                                <i class="fas fa-check-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº
                            </a>
                            
                            <form method="POST" action="{% url 'services:update_report_status' report.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="rejected">
                                <button type="submit" style="width: 100%; background: #dc3545; color: white; padding: 15px; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;">
                                    <i class="fas fa-times-circle"></i> Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº
                                </button>
                            </form>
                            
                            <form method="POST" action="{% url 'services:update_report_status' report.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="archived">
                                <button type="submit" style="width: 100%; background: #6c757d; color: white; padding: 15px; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;">
                                    <i class="fas fa-archive"></i> Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ù„Ø§Øº
                                </button>
                            </form>
                        </div>
                    </div>
                
                {% else %}
                    <!-- Ù…Ø­Ø¬ÙˆØ² Ù…Ù† Ù…ÙˆØ¸Ù Ø¢Ø®Ø± -->
                    <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <h3 style="color: #495057; font-size: 1.2rem; margin-bottom: 20px;">ÙŠÙ…ÙƒÙ†Ùƒ ÙÙƒ Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø­Ø¬Ø² Ø¨Ø§Ø³Ù…Ùƒ</h3>
                        <form method="POST" action="{% url 'services:release_criminal_report' report.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="force_reserve" value="true">
                            <button type="submit" style="background: #0066cc; color: white; padding: 15px 40px; border: none; border-radius: 10px; font-family: 'Tajawal', sans-serif; font-weight: 700; cursor: pointer; font-size: 1.1rem; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,102,204,0.3); transition: 0.3s;">
                                <i class="fas fa-exchange-alt"></i> ÙÙƒ Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø­Ø¬Ø² Ø¨Ø§Ø³Ù…ÙŠ
                            </button>
                        </form>
                    </div>
                {% endif %}

                <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© -->
                <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                    <h3 style="color: #495057; font-size: 1.1rem; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-sticky-note" style="color: #0066cc;"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©
                    </h3>
                    <p style="color: #6c757d; font-size: 0.9rem; margin-bottom: 15px;">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙ‚Ø· ÙˆÙ„Ù† ØªØ¸Ù‡Ø± Ù„Ù„Ù…ØªØ¹Ø§Ù…Ù„</p>
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
                    <div id="notesList" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                        {% for note in report.notes.all %}
                            {% if note.note_type == 'staff' and not note.is_deleted %}
                            <div class="note-item" data-note-id="{{ note.id }}" style="background: #f8f9fa; border-right: 4px solid #0066cc; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <span style="font-weight: 700; color: #0066cc; font-size: 0.9rem;">
                                            <i class="fas fa-user"></i> {{ note.created_by.get_full_name|default:note.created_by.username }}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: #6c757d; font-size: 0.85rem;">{{ note.created_at|date:"d/m/Y H:i" }}</span>
                                        {% if note.created_by == request.user or request.user.is_superuser %}
                                        <button onclick="deleteNote({{ note.id }})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                <div style="color: #495057; font-size: 0.95rem; white-space: pre-wrap;">{{ note.content }}</div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
                    <textarea class="notes-textarea" id="staffNotes" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©..."></textarea>
                    <button class="btn-save-notes" onclick="saveNotes('staff')">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
                    </button>
                </div>

                <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                    <h3 style="color: #495057; font-size: 1.1rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-history" style="color: #6c757d;"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                    </h3>
                    
                    {% if report.activities.all %}
                        <div style="max-height: 400px; overflow-y: auto;">
                            {% for activity in report.activities.all %}
                            <div style="background: {% cycle '#f8f9fa' '#ffffff' %}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-right: 4px solid 
                                {% if activity.action_type == 'created' %}#28a745
                                {% elif activity.action_type == 'reserved' %}#0066cc
                                {% elif activity.action_type == 'released' %}#ff9800
                                {% elif activity.action_type == 'status_changed' %}#17a2b8
                                {% elif activity.action_type == 'note_added' %}#6c757d
                                {% elif activity.action_type == 'question_sent' %}#6f42c1
                                {% else %}#6c757d{% endif %};">
                                
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <span style="font-weight: 700; color: #495057; font-size: 0.95rem;">
                                            {% if activity.action_type == 'created' %}âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº
                                            {% elif activity.action_type == 'reserved' %}ğŸ”’ ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ø·Ù„Ø¨
                                            {% elif activity.action_type == 'released' %}ğŸ”“ ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¬Ø²
                                            {% elif activity.action_type == 'status_changed' %}ğŸ”„ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
                                            {% elif activity.action_type == 'note_added' %}ğŸ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©
                                            {% elif activity.action_type == 'question_sent' %}â“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ø³Ø¦Ù„Ø©
                                            {% else %}ğŸ“‹ {{ activity.get_action_type_display }}{% endif %}
                                        </span>
                                    </div>
                                    <div style="text-align: left;">
                                        <span style="color: #6c757d; font-size: 0.85rem;">{{ activity.created_at|date:"d/m/Y H:i" }}</span>
                                    </div>
                                </div>
                                
                                <div style="color: #495057; font-size: 0.9rem; margin-bottom: 5px;">
                                    {{ activity.description }}
                                </div>
                                
                                {% if activity.user %}
                                <div style="color: #6c757d; font-size: 0.85rem;">
                                    <i class="fas fa-user" style="margin-left: 5px;"></i> {{ activity.user.get_full_name|default:activity.user.username }}
                                </div>
                                {% endif %}
                                
                                {% if activity.old_value and activity.new_value %}
                                <div style="margin-top: 8px; font-size: 0.85rem; color: #6c757d;">
                                    <span style="background: #fff3cd; padding: 2px 8px; border-radius: 4px;">{{ activity.old_value }}</span>
                                    <i class="fas fa-arrow-left" style="margin: 0 5px;"></i>
                                    <span style="background: #d4edda; padding: 2px 8px; border-radius: 4px;">{{ activity.new_value }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div style="text-align: center; padding: 30px; color: #6c757d;">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.closest('.tab').classList.add('active');
        }

        function showQuestions() {
            document.getElementById('questionsSection').classList.add('show');
            document.getElementById('questionsSection').scrollIntoView({ behavior: 'smooth' });
            setTimeout(() => {
                document.getElementById('additionalQuestions').focus();
            }, 300);
        }

        function showQuestionsInDetails() {
            const section = document.getElementById('questionsSectionDetails');
            section.classList.add('show');
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                document.getElementById('additionalQuestionsDetails').focus();
            }, 300);
        }

        function saveNotesFromDetails(type) {
            const reportId = {{ report.id }};
            let content = document.getElementById('additionalQuestionsDetails').value;
            let noteType = 'additional_questions';

            fetch(`/staff/criminal-report/${reportId}/notes/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `note_type=${noteType}&note_content=${encodeURIComponent(content)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                } else {
                    alert('Ø®Ø·Ø£: ' + (data.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            })
            .catch(error => {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                console.error(error);
            });
        }

        function saveNotes(type) {
            const reportId = {{ report.id }};
            let content = '';
            let noteType = '';

            if (type === 'staff') {
                content = document.getElementById('staffNotes').value;
                noteType = 'staff';
            } else if (type === 'questions') {
                content = document.getElementById('additionalQuestions').value;
                noteType = 'additional_questions';
            }

            if (!content || !content.trim()) {
                alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
                return;
            }

            fetch(`/staff/criminal-report/${reportId}/notes/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `note_type=${noteType}&content=${encodeURIComponent(content)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ“ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                } else {
                    alert('Ø®Ø·Ø£: ' + (data.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            })
            .catch(error => {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                console.error(error);
            });
        }

        function deleteNote(noteId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŸ')) {
                return;
            }

            fetch(`/staff/note/${noteId}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('âœ“ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                } else {
                    alert('Ø®Ø·Ø£: ' + (data.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            })
            .catch(error => {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                console.error(error);
            });
        }

        {% if messages %}
            {% for message in messages %}
                alert('{{ message }}');
            {% endfor %}
        {% endif %}
    </script>
</body>
</html>
